<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Isinkwe Energies LPG Savings Calculator</title>
<meta name="theme-color" content="#205d68" />
<link rel="manifest" href="manifest.json" />
<link rel="apple-touch-icon" href="https://drive.google.com/uc?export=view&id=1wtw8IH2L5W-rqBXf-ui-twG3uZ1AWTQp" />
<style>
  body { font-family: 'Segoe UI', Arial, sans-serif; background: #f5f5f5; margin: 0; padding: 0; color: #205d68;}
  .container { max-width: 700px; margin: 20px auto; background: #fff; border-radius: 18px; box-shadow: 0 8px 32px rgba(32,93,104,0.10); padding: 24px 16px;}
  .logo { display: block; margin: 0 auto 18px auto; max-width: 220px; border-radius: 10px;}
  .brandline {font-size: 1.6em; font-weight: bold; text-align: center; color: #205d68; margin-bottom: 18px;}
  .doc-buttons { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; margin-bottom: 20px; }
  .doc-btn { font-size: 1em; font-weight: bold; padding: 10px 18px; border-radius: 8px; border: none; cursor: pointer; }
  .tpn-btn { background: #205d68; color: #fff; }
  .deposit-btn { background: #ff9800; color: #205d68; }
  .exchange-btn { background: #4caf50; color: #fff; }
  .logo-btn { background: #eee; color: #205d68; }
  .info-block { background: #e0f7fa; border-radius: 8px; padding: 12px 18px; color: #205d68; margin: 18px 0; line-height: 1.5; white-space: pre-line;}
  fieldset { margin: 20px 0; padding: 20px; border-radius: 12px; border-left: 5px solid; }
  legend { font-size: 1.3em; font-weight: bold; color: #205d68; padding: 0 10px; }
  fieldset.client-info { background: #fce4ec; border-left-color: #e91e63; }
  fieldset.client-info legend { color: #e91e63; }
  fieldset.pricing-info { background: #e8f5e8; border-left-color: #4caf50; }
  fieldset.pricing-info legend { color: #4caf50; }
  fieldset.additional-costs { background: #fff3e0; border-left-color: #ff9800; }
  fieldset.additional-costs legend { color: #ff9800; }
  fieldset.finalization { background: #f3e5f5; border-left-color: #9c27b0; }
  fieldset.finalization legend { color: #9c27b0; }
  label { font-weight: 600; margin-top: 10px; display: block; }
  input, select { margin-bottom: 15px; padding: 8px; border-radius: 6px; border: 1px solid #b2dfdb; width: 100%; box-sizing: border-box; }
  .btn { background: #25D366; color: #fff; border: none; border-radius: 8px; padding: 10px 18px; font-size: 16px; font-weight: bold; cursor: pointer; margin: 10px 8px 0 0; }
  .email-btn { background: #205d68; }
  .pdf-btn { background: #2ec4b6; }
  .swap-btn { background: #ffd600; color: #205d68; }
  .add-cylinder-btn { background: #4caf50; padding: 8px 12px; font-size: 14px; }
  .remove-cylinder-btn { background: #f44336; padding: 4px 8px; font-size: 12px; }
  .cylinder-row {
    background: #f9f9f9;
    border: 1px solid #ddd;
    border-radius: 8px;
    padding: 15px;
    margin: 10px 0;
    position: relative;
  }
  .cylinder-row-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
  }
  .cylinder-row-title {
    font-weight: bold;
    color: #4caf50;
  }
  .cylinder-fields {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
    gap: 10px;
    margin-bottom: 10px;
  }
  .total-block {
    background:#e8f5e8;
    border-radius:12px;
    padding:16px;
    box-shadow:0 2px 8px rgba(46,196,182,0.3);
    margin-bottom: 30px;
    text-align:center;
  }
  .total-price {
    color:#2ec4b6;
    font-weight:900;
    font-size:1.6em;
    cursor:pointer;
    user-select:none;
  }
  .grid-container {
    display:grid;
    grid-template-columns: repeat(auto-fit,minmax(140px,1fr));
    gap:12px;
    font-weight:700;
    color:#205d68;
    font-size:1em;
    text-align:center;
    margin-top: 12px;
  }
  .grid-item-label {
    font-size: 1.1em;
    margin-bottom: 6px;
  }
  .highlight-savings {
    color:#2ec4b6;
    font-size:1.2em;
  }
  .cylinder-card {
    background: #f9f9f9;
    border-radius: 10px;
    padding: 12px 18px;
    box-shadow: 0 2px 6px rgba(32,93,104,0.1);
    color: #205d68;
    margin-bottom: 12px;
  }
  .cylinder-grid {
    display:grid;
    grid-template-columns: repeat(auto-fit,minmax(140px,1fr));
    gap:12px;
    font-weight:600;
  }
  .cylinder-grid div {
    text-align: center;
  }
  .cylinder-price {
    font-weight:900;
    font-size:1.3em;
    color:#2ec4b6;
  }
  table.savings-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 12px;
  }
  table.savings-table th, table.savings-table td {
    border: 1px solid #ccc;
    padding: 6px 10px;
    text-align: center;
    font-weight: 600;
    font-size: 0.9em;
  }
  table.savings-table th {
    background-color: #e8f5e8;
    color: #4caf50;
  }
  .footer {
    font-size:0.95em;
    color:#888;
    margin-top:18px;
    text-align:center;
  }
  @media (max-width: 600px) {
    .container { padding: 6px; }
    .logo { max-width: 180px; }
    .cylinder-fields { grid-template-columns: 1fr; }
    .cylinder-grid { grid-template-columns: 1fr; }
    table.savings-table th, table.savings-table td {
      font-size: 0.8em;
      padding: 4px 6px;
    }
  }
</style>
</head>
<body>
<div class="container">
  <img src="https://drive.google.com/uc?export=view&id=1wtw8IH2L5W-rqBXf-ui-twG3uZ1AWTQp" alt="Isinkwe Energies Logo" class="logo" />
  <div class="brandline">Isinkwe Energies LPG Savings Calculator</div>
  <div class="doc-buttons">
    <a href="https://ppl-ai-file-upload.s3.amazonaws.com/web/direct-files/attachments/67820504/a626ff0e-a951-424e-bae5-70ee5d6d9ca1/Isinkwe-Energies-TPN-Consent.pdf" target="_blank">
      <button class="doc-btn tpn-btn">üìÑ TPN Consent</button>
    </a>
    <a href="https://drive.google.com/file/d/1ypkcIMRQ0es5PnAZvKF--I8oDVNLNQWa/view?usp=drivesdk" target="_blank">
      <button class="doc-btn deposit-btn">üìÑ Cylinder Deposit</button>
    </a>
    <a href="https://drive.google.com/file/d/1p4iRkbrx35MwC9OJa15zn5o8sj_RDB-D/view?usp=drivesdk" target="_blank">
      <button class="doc-btn exchange-btn">üìÑ Cylinder Exchange</button>
    </a>
    <a href="https://drive.google.com/file/d/1wtw8IH2L5W-rqBXf-ui-twG3uZ1AWTQp/view?usp=drivesdk" target="_blank">
      <button class="doc-btn logo-btn">üñºÔ∏è Company Logo</button>
    </a>
  </div>
  <fieldset class="client-info">
    <legend>üìã Client Information</legend>
    <label for="clientName">Client Name:</label>
    <input type="text" id="clientName" autocomplete="name" />
    <label for="businessName">Business Name:</label>
    <input type="text" id="businessName" autocomplete="organization" />
    <label for="clientCell">Client Cell Number:</label>
    <input type="tel" id="clientCell" placeholder="+27 62 123 4567" autocomplete="tel" />
    <label for="clientEmail">Client Email Address:</label>
    <input type="email" id="clientEmail" placeholder="client@email.com" autocomplete="email" />
    <label for="clientAddress">Client Address:</label>
    <input type="text" id="clientAddress" placeholder="Your address will appear here" />
    <button type="button" class="btn swap-btn" onclick="getAddressFromGPS()">üìç Use Current Location</button>
  </fieldset>
  <fieldset class="additional-costs">
    <legend>üì¶ LPG Supply Information</legend>
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
      <h3 style="margin:0;color:#4caf50;">üõ¢Ô∏è Cylinders</h3>
      <button type="button" class="btn add-cylinder-btn" onclick="addCylinderRow()">+ Add Cylinder</button>
    </div>
    <div id="cylindersContainer"></div>
    <label for="cylinderOption">How will the client receive their cylinder?</label>
    <select id="cylinderOption" onchange="updateExchangeFields()">
      <option value="deposit">Pay Deposit</option>
      <option value="exchange">Exchange</option>
    </select>
    <div id="exchangeFields" style="display:none;margin-top:10px;">
      <button onclick="window.open('https://drive.google.com/file/d/1p4iRkbrx35MwC9OJa15zn5o8sj_RDB-D/view?usp=drivesdk','_blank')" class="btn exchange-btn">
        üìÑ LPG Cylinder Exchange Policy
      </button>
    </div>
  </fieldset>
  <fieldset class="pricing-info">
    <legend>üí∞ Pricing Information</legend>
    <label for="yourPrice">Isinkwe Price per kg (excl. VAT):</label>
    <input type="number" id="yourPrice" min="0" step="0.01" />
    <div style="margin:10px 0;">
      <label style="font-weight:600;">Known supplier price?</label>
      <label><input type="radio" name="knowPrice" value="yes" checked onchange="toggleMarketPriceInputs()" /> Yes</label>
      <label><input type="radio" name="knowPrice" value="no" onchange="toggleMarketPriceInputs()" /> No</label>
    </div>
    <div id="marketPricePerKgDiv">
      <label for="marketPrice">Market Price per kg (excl. VAT):</label>
      <input type="number" id="marketPrice" min="0" step="0.01" />
    </div>
    <div id="marketTotalPriceDiv" style="display:none; background:#fff8e1; border:1px dashed #ffb300; border-radius:6px; padding:10px;">
      <label for="marketTotalPrice">Supplier's Total Price:</label>
      <div style="display:flex;gap:10px;margin-top:6px;">
        <input type="number" id="marketTotalPrice" min="0" step="0.01" placeholder="e.g. 500" style="flex:1;" />
        <label><input type="checkbox" id="marketPriceInclVAT" onchange="calculateMarketPerKg()" /> Including VAT</label>
        <button type="button" class="btn deposit-btn" onclick="calculateMarketPerKg()">Auto-calc per kg</button>
      </div>
    </div>
    <label for="deliveryFee">Delivery Fee (R):</label>
    <input type="number" id="deliveryFee" min="0" step="0.01" />
  </fieldset>
  <fieldset class="finalization">
    <legend>‚úÖ Complete Quotation</legend>
    <button class="btn deposit-btn" onclick="calculateSavings()">Calculate Savings</button>
    <button class="btn email-btn" onclick="window.open('https://forms.clickup.com/9015674368/f/8cp0hg0-2235/79MEBGELBCGCD1P1IH','_blank')">
      Complete Application Form
    </button>
  </fieldset>
  <div id="quote-section" class="info-block" style="display:none;">
    <h2>üìä Quote Summary</h2>
    <div class="total-block">
      <h3 id="totalPriceLabel">Total Isinkwe Price (Excl. VAT):</h3>
      <div id="totalYourPrice" class="total-price" title="Click to toggle VAT"></div>
      <div class="grid-container">
        <div><div class="grid-item-label">Total Quantity (kg)</div><div id="totalQuantity"></div></div>
        <div><div class="grid-item-label">Total Supplier Price (<span id="marketPriceLabel">Excl. VAT</span>)</div><div id="totalMarketPrice" class="total-price" title="Click to toggle VAT"></div></div>
        <div><div class="grid-item-label">Total Savings (<span id="savingsLabel">Excl. VAT</span>)</div><div id="totalSavings" class="highlight-savings total-price" title="Click to toggle VAT"></div></div>
        <div><div class="grid-item-label">Delivery Fee (Incl. VAT)</div><div id="deliveryFeeDisplay"></div></div>
        <div><div class="grid-item-label">Deposit Fee</div><div id="depositFeeDisplay"></div></div>
      </div>
    </div>
    <h3>üõ¢Ô∏è Cylinder Details</h3>
    <div id="cylinderDetailsContainer"></div>
    <h3>Savings Over Time</h3>
    <table class="savings-table" aria-label="Savings over different periods">
      <thead><tr><th>Period</th><th>Savings (R)</th></tr></thead>
      <tbody>
        <tr><td>Per Month</td><td id="savingsPerMonth"></td></tr>
        <tr><td>Per Quarter</td><td id="savingsPerQuarter"></td></tr>
        <tr><td>Per Six Months</td><td id="savingsPerSixMonths"></td></tr>
        <tr><td>Per Year</td><td id="savingsPerYear"></td></tr>
      </tbody>
    </table>
  </div>
  <div id="afterQuoteLinks" style="display:none;">
    <button class="btn pdf-btn" onclick="downloadPDF()">Download PDF</button>
    <button class="btn swap-btn" onclick="sendWhatsAppBusinessQuote()">Send via WhatsApp Business</button>
    <button class="btn email-btn" onclick="sendEmailQuote()">Send via Email</button>
  </div>
  <div id="tpnConsentField" style="display:none;">
    <button onclick="window.open('https://ppl-ai-file-upload.s3.amazonaws.com/web/direct-files/attachments/67820504/a626ff0e-a951-424e-bae5-70ee5d6d9ca1/Isinkwe-Energies-TPN-Consent.pdf','_blank')" class="btn tpn-btn">
      TPN Consent
    </button>
  </div>
  <div class="footer">
    Reg. no. 2015/161765/07 | VAT no. 4900 272 354<br>
    1A Glen Anil Street, Glen Anil, Durban, South Africa, 4051<br>
    Tel: +27 87 350 1209 | Email: info@isinkwegroup.com
  </div>
</div>
<script>
const VAT_RATE = 0.15;
const depositAmounts = {
  "9": 450,
  "14": 550,
  "19": 600,
  "19-forklift": 700,
  "48-single": 1050,
  "48-double": 1050
};
let cylinderCounter = 0;
let showIncludingVAT = false;

document.addEventListener('DOMContentLoaded', () => {
  addCylinderRow();
  toggleMarketPriceInputs();
  updateExchangeFields();
  attachToggleListeners();
  document.getElementById('marketTotalPrice').addEventListener('input', calculateMarketPerKg);
  document.getElementById('marketPriceInclVAT').addEventListener('change', calculateMarketPerKg);
  document.getElementById('cylinderOption').addEventListener('change', updateExchangeFields);
});

async function getAddressFromGPS() {
  if (!navigator.geolocation) {
    alert("Geolocation is not supported by your browser.");
    return;
  }
  navigator.geolocation.getCurrentPosition(async position => {
    const lat = position.coords.latitude;
    const lon = position.coords.longitude;
    try {
      const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lon}`);
      if (!response.ok) throw new Error('Network response was not ok');
      const data = await response.json();
      if (data && data.display_name) {
        document.getElementById('clientAddress').value = data.display_name;
      } else {
        alert("Address not found for your location.");
      }
    } catch (error) {
      alert("Failed to get address from location.");
      console.error(error);
    }
  }, error => {
    alert("Unable to retrieve your location. Please check your permissions.");
    console.error(error);
  });
}

function toggleMarketPriceInputs() {
  const knowPrice = document.querySelector('input[name="knowPrice"]:checked').value;
  document.getElementById('marketPricePerKgDiv').style.display = 'block';
  document.getElementById('marketTotalPriceDiv').style.display = knowPrice === 'no' ? 'block' : 'none';
}

function calculateMarketPerKg() {
  const totalPrice = parseFloat(document.getElementById('marketTotalPrice').value) || 0;
  const inclVAT = document.getElementById('marketPriceInclVAT').checked;
  const firstCylinderSizeSelect = document.querySelector('.cylinder-row select[id^="cylinderSize-"]');
  const cylinderSize = firstCylinderSizeSelect ? parseFloat(firstCylinderSizeSelect.value) : 0;
  if (totalPrice > 0 && cylinderSize > 0) {
    const exclVATPrice = inclVAT ? totalPrice / (1 + VAT_RATE) : totalPrice;
    const perKg = exclVATPrice / cylinderSize;
    document.getElementById('marketPrice').value = perKg.toFixed(2);
  }
}

function addCylinderRow() {
  cylinderCounter++;
  const container = document.getElementById('cylindersContainer');
  const row = document.createElement('div');
  row.className = 'cylinder-row';
  row.id = `cylinder-${cylinderCounter}`;
  row.innerHTML = `
    <div class="cylinder-row-header">
      <div class="cylinder-row-title">Cylinder ${cylinderCounter}</div>
      ${cylinderCounter > 1 ? `<button type="button" class="btn remove-cylinder-btn" onclick="removeCylinderRow(${cylinderCounter})">Remove</button>` : ''}
    </div>
    <div class="cylinder-fields">
      <div>
        <label for="cylinderSize-${cylinderCounter}">Cylinder Size (kg):</label>
        <select id="cylinderSize-${cylinderCounter}">
          <option value="9">9</option>
          <option value="14">14</option>
          <option value="19" selected>19</option>
          <option value="19-forklift">19-Forklift</option>
          <option value="48-single">48-Single</option>
          <option value="48-double">48-Double</option>
        </select>
      </div>
      <div>
        <label for="qtyPerOrder-${cylinderCounter}">Quantity per Order:</label>
        <input type="number" id="qtyPerOrder-${cylinderCounter}" value="1" min="1">
      </div>
      <div>
        <label for="ordersPerMonth-${cylinderCounter}">Orders per Month:</label>
        <input type="number" id="ordersPerMonth-${cylinderCounter}" value="1" min="1">
      </div>
    </div>
  `;
  container.appendChild(row);
}

function removeCylinderRow(id) {
  const row = document.getElementById(`cylinder-${id}`);
  if (row) row.remove();
}

function getTotalCylinderWeight() {
  let total = 0;
  document.querySelectorAll('.cylinder-row').forEach(row => {
    const id = row.id.split('-')[1];
    const size = parseFloat(document.getElementById(`cylinderSize-${id}`).value) || 0;
    const qty = parseInt(document.getElementById(`qtyPerOrder-${id}`).value) || 0;
    const freq = parseInt(document.getElementById(`ordersPerMonth-${id}`).value) || 0;
    total += size * qty * freq;
  });
  return total;
}

function updateExchangeFields() {
  const option = document.getElementById('cylinderOption').value;
  document.getElementById('exchangeFields').style.display = option === 'exchange' ? 'block' : 'none';
  document.getElementById('tpnConsentField').style.display = option === 'deposit' ? 'block' : 'none';
}

function calculateSavings() {
  const yourPrice = parseFloat(document.getElementById("yourPrice").value) || 0;
  const deliveryFee = parseFloat(document.getElementById("deliveryFee").value) || 0;
  const cylinderOption = document.getElementById('cylinderOption').value;

  const cylinders = [];
  let depositFee = 0;

  document.querySelectorAll('.cylinder-row').forEach(row => {
    const id = row.id.split('-')[1];
    const size = document.getElementById(`cylinderSize-${id}`).value;
    const sizeNum = parseFloat(size) || 0;
    const qtyPerOrder = parseInt(document.getElementById(`qtyPerOrder-${id}`).value) || 0;
    const ordersPerMonth = parseInt(document.getElementById(`ordersPerMonth-${id}`).value) || 0;
    const marketPrice = parseFloat(document.getElementById(`marketPrice`).value) || 0;

    if (sizeNum > 0 && qtyPerOrder > 0 && ordersPerMonth > 0) {
      if (cylinderOption === 'deposit') {
        depositFee += (depositAmounts[size] || 0) * qtyPerOrder;
      }
      cylinders.push({
        size: sizeNum,
        qtyPerOrder,
        ordersPerMonth,
        marketPrice,
        yourExcl: yourPrice * sizeNum,
        yourIncl: yourPrice * sizeNum * (1 + VAT_RATE),
        marketExcl: marketPrice * sizeNum,
        marketIncl: marketPrice * sizeNum * (1 + VAT_RATE)
      });
    }
  });

  if (cylinders.length === 0) {
    alert('Please add at least one cylinder with valid data.');
    return;
  }

  window.cylindersData = cylinders;

  // Calculate totals (EXCLUDE deposit fee)
  let totalQuantity = 0, totalYourExcl = 0, totalYourIncl = 0, totalMarketExcl = 0, totalMarketIncl = 0;
  cylinders.forEach(cyl => {
    const qtyTotal = cyl.qtyPerOrder * cyl.ordersPerMonth;
    totalQuantity += qtyTotal;
    totalYourExcl += cyl.yourExcl * qtyTotal;
    totalYourIncl += cyl.yourIncl * qtyTotal;
    totalMarketExcl += cyl.marketExcl * qtyTotal;
    totalMarketIncl += cyl.marketIncl * qtyTotal;
  });

  // Add delivery fee (incl VAT) ONLY to totalYourIncl
  totalYourIncl += deliveryFee;

  window.quoteTotals = {
    totalQuantity,
    totalYourExcl,
    totalYourIncl,
    totalMarketExcl,
    totalMarketIncl,
    totalSavingsExcl: totalMarketExcl - totalYourExcl,
    deliveryFee,
    depositFee // SHOWN SEPARATELY
  };

  showIncludingVAT = false;
  updateQuoteDisplay();
  attachToggleListeners();

  document.getElementById('quote-section').style.display = 'block';
  document.getElementById('afterQuoteLinks').style.display = 'block';
  updateExchangeFields();
}

function updateQuoteDisplay() {
  const q = window.quoteTotals;
  if (!q) return;
  const fmt = num => num.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2});

  document.getElementById('totalPriceLabel').textContent = showIncludingVAT
    ? 'Total Isinkwe Price (Incl. VAT):'
    : 'Total Isinkwe Price (Excl. VAT):';

  document.getElementById('marketPriceLabel').textContent = showIncludingVAT ? 'Incl. VAT' : 'Excl. VAT';
  document.getElementById('savingsLabel').textContent = showIncludingVAT ? 'Incl. VAT' : 'Excl. VAT';

  document.getElementById('totalYourPrice').textContent = showIncludingVAT ? fmt(q.totalYourIncl) : fmt(q.totalYourExcl);
  document.getElementById('totalQuantity').textContent = fmt(q.totalQuantity);
  document.getElementById('totalMarketPrice').textContent = showIncludingVAT ? fmt(q.totalMarketIncl) : fmt(q.totalMarketExcl);
  document.getElementById('totalSavings').textContent = showIncludingVAT ? fmt(q.totalSavingsExcl * (1 + VAT_RATE)) : fmt(q.totalSavingsExcl);
  document.getElementById('deliveryFeeDisplay').textContent = (q.deliveryFee || 0).toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2});
  document.getElementById('depositFeeDisplay').textContent = (q.depositFee || 0).toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2});

  const container = document.getElementById('cylinderDetailsContainer');
  container.innerHTML = '';
  window.cylindersData.forEach(cyl => {
    const qtyTotal = cyl.qtyPerOrder * cyl.ordersPerMonth;
    const yourPrice = showIncludingVAT ? cyl.yourIncl : cyl.yourExcl;
    const marketPrice = showIncludingVAT ? cyl.marketIncl : cyl.marketExcl;
    const savings = showIncludingVAT ? (cyl.marketIncl - cyl.yourIncl) : (cyl.marketExcl - cyl.yourExcl);

    const card = document.createElement('div');
    card.className = 'cylinder-card';
    card.innerHTML = `
      <h4>${cyl.size} kg Cylinder</h4>
      <div class="cylinder-grid">
        <div>Quantity per Order:<br><strong>${cyl.qtyPerOrder}</strong></div>
        <div>Orders per Month:<br><strong>${cyl.ordersPerMonth}</strong></div>
        <div>Total Quantity:<br><strong>${fmt(qtyTotal)}</strong></div>
        <div>Isinkwe Price/kg (${showIncludingVAT ? 'Incl. VAT' : 'Excl. VAT'}):<br><span class="cylinder-price">R${fmt(yourPrice)}</span></div>
        <div>Market Price/kg (${showIncludingVAT ? 'Incl. VAT' : 'Excl. VAT'}):<br><strong>R${fmt(marketPrice)}</strong></div>
        <div>Savings (${showIncludingVAT ? 'Incl. VAT' : 'Excl. VAT'}):<br><span class="highlight-savings">R${fmt(savings)}</span></div>
      </div>
    `;
    container.appendChild(card);
  });

  // Savings over time (always excl VAT for clarity)
  const savingsPerMonth = window.cylindersData.reduce((sum,cyl) => {
    return sum + (cyl.marketExcl - cyl.yourExcl) * cyl.qtyPerOrder * cyl.ordersPerMonth;
  }, 0);
  document.getElementById('savingsPerMonth').textContent = fmt(savingsPerMonth);
  document.getElementById('savingsPerQuarter').textContent = fmt(savingsPerMonth * 3);
  document.getElementById('savingsPerSixMonths').textContent = fmt(savingsPerMonth * 6);
  document.getElementById('savingsPerYear').textContent = fmt(savingsPerMonth * 12);
}

function attachToggleListeners() {
  ['totalYourPrice', 'totalMarketPrice', 'totalSavings'].forEach(id => {
    const el = document.getElementById(id);
    if (el) {
      el.style.cursor = 'pointer';
      el.title = 'Click to toggle VAT';
      el.onclick = () => {
        showIncludingVAT = !showIncludingVAT;
        updateQuoteDisplay();
      };
    }
  });
}

function sendWhatsAppBusinessQuote() {
  let clientCellRaw = document.getElementById('clientCell').value || '';
  let digitsOnly = clientCellRaw.replace(/\D/g, '');
  if (digitsOnly.startsWith('0')) digitsOnly = digitsOnly.substring(1);
  const phone = "27" + digitsOnly;

  const name = document.getElementById('clientName').value || '[Client Name]';
  const address = document.getElementById('clientAddress').value || '[Client Address]';
  const q = window.quoteTotals || {};
  const totGasExcl = (q.totalYourExcl || 0).toFixed(2);
  const supplierTotal = (q.totalMarketExcl || 0).toFixed(2);
  const depositFee = (q.depositFee || 0).toFixed(2);
  const deliveryFee = (q.deliveryFee || 0).toFixed(2);
  const monthlySavings = (q.totalSavingsExcl || 0).toFixed(2);

  const logoLink = "https://drive.google.com/uc?export=view&id=1wtw8IH2L5W-rqBXf-ui-twG3uZ1AWTQp";
  const siteLink = "https://isinkwegroup.com";

  const message =
    `Hi ${name},\n\n` +
    `Thank you for considering Isinkwe Energies as your trusted LPG supplier.\n\n` +
    `Based on the information you‚Äôve shared for your premises at ${address},\n` +
    `we‚Äôve prepared the quotation below:\n\n` +
    `‚Ä¢ Total Gas Cost (excl. VAT): R${totGasExcl}\n` +
    `‚Ä¢ Supplier‚Äôs Total Price (excl. VAT): R${supplierTotal}\n` +
    `‚Ä¢ Deposit Fee: R${depositFee}\n` +
    `‚Ä¢ Delivery Fee (excl. VAT): R${deliveryFee}\n` +
    `‚Ä¢ Estimated Monthly Savings (excl. VAT): R${monthlySavings}\n\n` +
    `This quotation reflects your current usage pattern and our transparent pricing. ` +
    `We aim to deliver consistent supply, competitive rates, and service you can count on.\n\n` +
    `We trust this quote clearly demonstrates the value we bring. ` +
    `Please let me know if you have any questions or are ready to proceed.\n\n` +
    `Kind regards,\n` +
    `Sifiso Brian Mbandlwa\n` +
    `Isinkwe Energies\n` +
    `sales.kzn@isinkwegroup.com\n` +
    `+27 69 946 6588\n\n` +
    `üîó Logo: ${logoLink}\n` +
    `üåê Website: ${siteLink}`;

  const encodedMessage = encodeURIComponent(message);
  window.open(`https://wa.me/${phone}?text=${encodedMessage}`, '_blank');
}

function sendEmailQuote() {
  const name = document.getElementById('clientName').value || '[Client Name]';
  const address = document.getElementById('clientAddress').value || '[Client Address]';

  const q = window.quoteTotals || {};

  const totGasExcl = (q.totalYourExcl || 0).toFixed(2);
  const supplierTotal = (q.totalMarketExcl || 0).toFixed(2);
  const depositFee = (q.depositFee || 0).toFixed(2);
  const deliveryFee = (q.deliveryFee || 0).toFixed(2);
  const monthlySavings = (q.totalSavingsExcl || 0).toFixed(2);
  const quarterSavings = ((q.totalSavingsExcl || 0) * 3).toFixed(2);
  const sixMonthSavings = ((q.totalSavingsExcl || 0) * 6).toFixed(2);
  const yearSavings = ((q.totalSavingsExcl || 0) * 12).toFixed(2);

  const subject = encodeURIComponent(`Isinkwe Energies LPG Quotation for ${name}`);
  const logoLink = "https://drive.google.com/uc?export=view&id=1wtw8IH2L5W-rqBXf-ui-twG3uZ1AWTQp";

  const body = encodeURIComponent(
    `Dear ${name},\n\n` +
    `Thank you for considering Isinkwe Energies as your trusted LPG supplier.\n\n` +
    `Based on your requirements at ${address}, we‚Äôve prepared the quotation below (all figures excl. VAT unless otherwise stated):\n\n` +
    `Quotation Summary:\n` +
    `‚Ä¢ Total Gas Cost: R${totGasExcl}\n` +
    `‚Ä¢ Supplier‚Äôs Total Price: R${supplierTotal}\n` +
    `‚Ä¢ Deposit Fee: R${depositFee}\n` +
    `‚Ä¢ Delivery Fee: R${deliveryFee}\n` +
    `‚Ä¢ Estimated Monthly Savings: R${monthlySavings}\n\n` +
    `Savings Forecast:\n` +
    `‚Ä¢ Per Quarter: R${quarterSavings}\n` +
    `‚Ä¢ Six Months: R${sixMonthSavings}\n` +
    `‚Ä¢ Per Year: R${yearSavings}\n\n` +
    `You can download our logo for reference or to attach when forwarding this quote:\n${logoLink}\n\n` +
    `Please reply if you‚Äôd like to proceed or have any questions.\n\n` +
    `Kind regards,\n` +
    `Sifiso Brian Mbandlwa\n` +
    `LPG Specialist, Isinkwe Energies\n` +
    `Email: sales.kzn@isinkwegroup.com\n` +
    `Phone: +27 69 946 6588`
  );

  window.location.href = `mailto:?subject=${subject}&body=${body}`;
}

function downloadPDF() {
  alert("PDF download feature coming soon. You can integrate jsPDF or similar library here.");
}

if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('service-worker.js')
      .then(registration => {
        console.log('ServiceWorker registered with scope:', registration.scope);
      })
      .catch(error => {
        console.log('ServiceWorker registration failed:', error);
      });
  });
}
</script>
</body>
</html>
